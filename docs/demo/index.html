<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCIIGround demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/common.css">
    <link rel="stylesheet" href="../styles/demo.css">
</head>

<body>
    <div class="loading gradient-text" id="loading"> Loading ASCIIGround... </div>

    <div class="header glass">
        <h1 class="gradient-text">
            <span class="terminal-symbol">></span>
            ASCIIGround
        </h1>
    </div>

    <form class="controls glass hidden" id="controls">
        <h2 class="gradient-text">Controls</h2>

        <label>
            <span> Pattern </span>

            <select id="pattern">
                <option value="perlin">Perlin Noise</option>
                <option value="wave">Wave</option>
                <option value="rain">Rain</option>
                <option value="static">Static</option>
                <option value="japan-rain">Japan Rain</option>
            </select>
        </label>

        <label id="characters-label">
            <span> Characters (comma-separated) </span>
            <input type="text" id="characters" value=". ,: ; + * # @">
        </label>

        <label>
            <span> Speed </span>
            <input type="number" id="speed" step="0.001" min="0.001" value="0.01">
        </label>

        <label>
            <span> Font size </span>
            <input type="number" id="fontSize" value="12">
        </label>

        <label>
            <span> Font family </span>
            <input type="text" id="fontFamily" value="monospace">
        </label>

        <label>
            <span> Text color </span>
            <input type="color" id="color" value="#00ff00">
        </label>

        <label>
            <span> Background color </span>
            <input type="color" id="backgroundColor" value="#000000">
        </label>

        <label>
            <span> Direction </span>

            <select id="direction">
                <option value="down"> Down </option>
                <option value="up"> Up </option>
                <option value="left"> Left </option>
                <option value="right"> Right </option>
            </select>
        </label>

        <label>
            <span> Amplitude X (wave) </span>
            <input type="number" id="amplitudeX" value="1" step="0.1">
        </label>

        <label>
            <span> Amplitude Y (wave) </span>
            <input type="number" id="amplitudeY" value="1" step="0.1">
        </label>

        <label>
            <span> Frequency (wave) </span>
            <input type="number" id="frequency" value="1" step="0.1">
        </label>

        <label>
            <span> Noise scale (perlin) </span>
            <input type="number" id="noiseScale" value="0.1" step="0.01">
        </label>

        <label>
            <span> Rain density (rain/japan-rain, 0-1) </span>
            <input type="number" id="rainDensity" min="0" max="1" step="0.01" value="0.9">
        </label>

        <label>
            <span> Rain direction (rain) </span>

            <select id="rainDirection">
                <option value="vertical">Vertical</option>
                <option value="diagonal-left">Diagonal Left</option>
                <option value="diagonal-right">Diagonal Right</option>
            </select>
        </label>

        <label class="toggle-label">
            <span> Animation </span>
            <div class="toggle-switch">
                <input type="checkbox" id="toggleBtn" checked>
                <span class="toggle-slider"></span>
            </div>
        </label>
    </form>

    <canvas id="background-canvas"></canvas>
    <script src="../../dist/asciiground.umd.js"></script>
    <!-- <script src="https://unpkg.com/asciiground@latest/dist/asciiground.umd.js"></script> -->

    <script>
        let ascii;
        let currentSpeed = 0.001;
        let currentPatternName = 'perlin';

        const patterns = {
            perlin: [' ', '.', ':', ';', '+', '*', '#', '@'],
            wave: ['~', '-', '=', '#', '▓', '█'],
            rain: ['|', '!', '1', ':', '.', ' '],
            static: [' ', '.', '*', '#', '▓', '█']
        };

        function initBackground() {
            const canvas = document.getElementById('background-canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const options = getOptionsFromInputs();

            if (options.pattern === 'japan-rain')
                options.characters = ['japan'];

            try {
                ascii = new ASCIIGround.default(canvas, {
                    pattern: 'perlin',
                    characters: patterns.perlin,
                    speed: currentSpeed,
                    fontSize: 12,
                    color: '#667eea',
                    backgroundColor: '#292929',
                });

                ascii.init();
                setInputsFromOptions(options);
                updateInfo();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('controls').classList.remove('hidden');
                document.getElementById('info').style.display = 'block';
            } catch (error) {
                console.error('Failed to initialize ASCIIGround:', error);
                document.getElementById('loading').textContent = 'Failed to load ASCIIGround library.';
            }
        }

        function getOptionsFromInputs() {
            let pattern = document.getElementById('pattern').value;
            let charactersInput = document.getElementById('characters').value;
            let characters = charactersInput.split(',').map(s => s.trim()).filter(Boolean);

            if (pattern === "japan-rain")
                characters = ['japan'];

            return {
                pattern: pattern,
                characters: characters,
                speed: parseFloat(document.getElementById('speed').value),
                fontSize: parseInt(document.getElementById('fontSize').value),
                fontFamily: document.getElementById('fontFamily').value,
                color: document.getElementById('color').value,
                backgroundColor: document.getElementById('backgroundColor').value,
                direction: document.getElementById('direction').value,
                amplitudeX: parseFloat(document.getElementById('amplitudeX').value),
                amplitudeY: parseFloat(document.getElementById('amplitudeY').value),
                frequency: parseFloat(document.getElementById('frequency').value),
                noiseScale: parseFloat(document.getElementById('noiseScale').value),
                rainDensity: parseFloat(document.getElementById('rainDensity').value),
                rainDirection: document.getElementById('rainDirection').value
            };
        }

        function setInputsFromOptions(opts) {
            document.getElementById('pattern').value = opts.pattern;

            if (opts.pattern !== 'japan-rain')
                document.getElementById('characters').value = opts.characters.join(', ');

            document.getElementById('speed').value = opts.speed;
            document.getElementById('fontSize').value = opts.fontSize;
            document.getElementById('fontFamily').value = opts.fontFamily;
            document.getElementById('color').value = opts.color;
            document.getElementById('backgroundColor').value = opts.backgroundColor;
            document.getElementById('direction').value = opts.direction;
            document.getElementById('amplitudeX').value = opts.amplitudeX;
            document.getElementById('amplitudeY').value = opts.amplitudeY;
            document.getElementById('frequency').value = opts.frequency;
            document.getElementById('noiseScale').value = opts.noiseScale;
            document.getElementById('rainDensity').value = opts.rainDensity;
            document.getElementById('rainDirection').value = opts.rainDirection;
        }

        function setPattern(pattern) {
            if (ascii && patterns[pattern]) {
                currentPatternName = pattern;

                ascii.updateOptions({
                    pattern: pattern,
                    characters: patterns[pattern]
                });

                updateInfo();
                updateActiveButton();
            }
        }

        function toggleAnimation() {
            if (!ascii)
                return;

            const toggleBtn = document.getElementById('toggleBtn');
            const isChecked = toggleBtn.checked;

            if (isChecked && !ascii.isAnimating) {
                ascii.startAnimation();
            } else if (!isChecked && ascii.isAnimating) {
                ascii.stopAnimation();
            }

            setPattern(currentPatternName);
        }

        function changeSpeed(event) {
            const speeds = [0.001, 0.005, 0.01, 0.02, 0.05, 0.1];
            const currentIndex = speeds.indexOf(currentSpeed);
            const nextIndex = (currentIndex + 1) % speeds.length;
            currentSpeed = speeds[nextIndex];
            event.target.textContent = `Change speed (${currentSpeed})`;

            if (ascii) {
                ascii.updateOptions({ speed: currentSpeed });
                updateInfo();
            }
        }

        function updateInfo() {
            // const opts = getOptionsFromInputs();
            // let displayOpts = { ...opts };

            // if (opts.pattern === 'japan-rain') {
            //     displayOpts.characters = "Japanese (auto)";
            // } else {
            //     displayOpts.characters = opts.characters.join(', ');
            // }

            // const info = Object.entries(displayOpts)
            //     .map(([k, v]) => `<strong>${k}:</strong> ${typeof v === 'object' ? JSON.stringify(v) : v}`)
            //     .join('<br>');

            // document.getElementById('current-settings').innerHTML = info;
        }

        function applyOptions() {
            const options = getOptionsFromInputs();
            console.log('Applying options:', options);

            if (ascii) {
                const prevPattern = ascii.options?.pattern;

                if (options.pattern !== prevPattern) {
                    ascii.stopAnimation();
                    ascii = null;
                    setTimeout(initBackground, 50);
                    return;
                }

                ascii.updateOptions(options);

                if (options.animated && !isAnimating) {
                    ascii.startAnimation();
                    isAnimating = true;
                } else if (!options.animated && isAnimating) {
                    ascii.stopAnimation();
                    isAnimating = false;
                }

                updateInfo();
            }
        }

        function lockInputsForJapanRain(isJapanRain) {
            const charactersInput = document.getElementById('characters');
            const charactersLabel = document.getElementById('characters-label');

            if (isJapanRain) {
                charactersInput.classList.add('locked');
                charactersInput.readOnly = true;
                charactersLabel.classList.add('locked');
                charactersInput.value = "Japanese (auto)";
            } else {
                charactersInput.classList.remove('locked');
                charactersInput.readOnly = false;
                charactersLabel.classList.remove('locked');
            }

            const direction = document.getElementById('direction');

            for (const opt of direction.options)
                opt.disabled = false;
        }

        function updateActiveButton() {
            ['perlin', 'wave', 'rain', 'static'].forEach(pattern => {
                document.getElementById(`btn-${pattern}`).classList.remove('active');
            });

            document.getElementById(`btn-${currentPatternName}`).classList.add('active');
        }

        window.addEventListener('resize', () => {
            if (ascii) {
                const canvas = document.getElementById('background-canvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ascii.resize(canvas.width, canvas.height);
            }
        });

        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case '1': setPattern('perlin'); break;
                case '2': setPattern('wave'); break;
                case '3': setPattern('rain'); break;
                case '4': setPattern('static'); break;
                case ' ':
                    event.preventDefault();
                    toggleAnimation();
                    break;
                case 's':
                case 'S':
                    changeSpeed();
                    break;
            }
        });

        document.getElementById('toggleBtn').addEventListener('change', toggleAnimation);

        [
            'pattern', 'characters', 'speed', 'fontSize', 'fontFamily',
            'color', 'backgroundColor', 'direction', 'amplitudeX', 'amplitudeY',
            'frequency', 'noiseScale', 'rainDensity', 'rainDirection'
        ].forEach(id => {
            document.getElementById(id)?.addEventListener('change', applyOptions);
        });

        document.getElementById('pattern').addEventListener('change', function () {
            lockInputsForJapanRain(this.value === 'japan-rain');
            applyOptions();
        });

        window.addEventListener('load', () => {
            lockInputsForJapanRain(document.getElementById('pattern').value === 'japan-rain');
            setTimeout(initBackground, 250);
        });
    </script>
</body>

</html>