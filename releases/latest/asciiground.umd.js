(function(c,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(c=typeof globalThis<"u"?globalThis:c||self,l(c.ASCIIGround={}))})(this,function(c){"use strict";var F=Object.defineProperty;var H=(c,l,d)=>l in c?F(c,l,{enumerable:!0,configurable:!0,writable:!0,value:d}):c[l]=d;var h=(c,l,d)=>H(c,typeof l!="symbol"?l+"":l,d);const l={characters:["█","▓","▒","░"," "]};class d{constructor(s={}){h(this,"_options");h(this,"_isDirty",!1);this._options={...l,...s}}get id(){return this.constructor.ID}get options(){return this._options}get isDirty(){return this._isDirty}set isDirty(s){this._isDirty=s}setOptions(s){this._isDirty=this._hasOptionsChanged(s),this._options={...this._options,...s}}initialize(s){}destroy(){}onMouseInteraction(s,t,i){}_hasOptionsChanged(s){return Object.keys(s).some(t=>{const i=this._options[t],e=s[t];return i!==e})}}h(d,"ID");class f extends d{constructor(s={}){super(s)}update(s){return this}generate(s){return[]}}h(f,"ID","dummy");class m{constructor(){h(this,"_canvas");h(this,"_context");h(this,"_options")}get options(){return this._options}set options(s){this._options=s,this._setupContext()}initialize(s,t){this._canvas=s,this._options=t;const i=s.getContext("2d");if(!i)throw new Error("Could not get 2D context from canvas");this._context=i,this._setupContext()}clear(s){this._context.fillStyle=s,this._context.fillRect(0,0,this._canvas.width,this._canvas.height),this._context.fillStyle=this._options.color}render(s,t){const i=t.startColumn!==0||t.startRow!==0||t.endColumn!==t.columns||t.endRow!==t.rows;i&&(this._context.save(),this._context.beginPath(),this._context.rect(t.startColumn*t.charSpacingX,t.startRow*t.charSpacingY,(t.endColumn-t.startColumn)*t.charSpacingX,(t.endRow-t.startRow)*t.charSpacingY),this._context.clip());for(const e of s)e.x<0||e.x>=t.canvasWidth||e.y<0||e.y>=t.canvasHeight||(e.opacity!==void 0&&(this._context.globalAlpha=e.opacity),e.color&&(this._context.fillStyle=e.color),e.scale!==void 0||e.rotation!==void 0?(this._context.save(),this._context.translate(e.x+t.charWidth/2,e.y+t.charHeight/2),e.rotation!==void 0&&this._context.rotate(e.rotation),e.scale!==void 0&&this._context.scale(e.scale,e.scale),this._context.fillText(e.char,-t.charWidth/2,-t.charHeight/2),this._context.restore()):this._context.fillText(e.char,e.x,e.y),e.opacity!==void 0&&(this._context.globalAlpha=1),e.color&&(this._context.fillStyle=this._options.color));i&&this._context.restore()}resize(s,t){this._canvas.width=s,this._canvas.height=t,this._setupContext()}destroy(){}_setupContext(){this._context.font=`${this._options.fontSize}px ${this._options.fontFamily}`,this._context.textBaseline="top",this._context.fillStyle=this._options.color}}class v{constructor(){h(this,"_gl");h(this,"_canvas");h(this,"_program");h(this,"_options");h(this,"_isInitialized",!1)}get options(){return this._options}set options(s){this._options=s}initialize(s){this._canvas=s;const t=s.getContext("webgl2");if(!t)throw new Error("Could not get WebGL2 context from canvas.");this._gl=t,this._setupWebGL(),this._isInitialized=!0}clear(s){if(!this._isInitialized)return;const t=this._gl,i=s.replace("#",""),e=parseInt(i.substring(0,2),16)/255,n=parseInt(i.substring(2,4),16)/255,a=parseInt(i.substring(4,6),16)/255;t.clearColor(e,n,a,1),t.clear(t.COLOR_BUFFER_BIT)}render(s,t){this._isInitialized}resize(s,t){this._isInitialized&&(this._canvas.width=s,this._canvas.height=t,this._gl.viewport(0,0,s,t))}destroy(){if(!this._isInitialized)return;const s=this._gl;this._program&&s.deleteProgram(this._program),this._isInitialized=!1}_setupWebGL(){const s=this._gl,t=`#version 300 es
            precision mediump float;
            
            in vec2 a_position;
            in vec2 a_texCoord;
            in float a_opacity;
            
            uniform vec2 u_resolution;
            uniform mat3 u_transform;
            
            out vec2 v_texCoord;
            out float v_opacity;
            
            void main() {
                vec3 position = u_transform * vec3(a_position, 1.0);
                vec2 clipSpace = ((position.xy / u_resolution) * 2.0 - 1.0) * vec2(1, -1);
                gl_Position = vec4(clipSpace, 0, 1);
                v_texCoord = a_texCoord;
                v_opacity = a_opacity;
            }
        `,i=`#version 300 es
            precision mediump float;
            
            in vec2 v_texCoord;
            in float v_opacity;
            
            uniform sampler2D u_texture;
            uniform vec3 u_color;
            
            out vec4 fragColor;
            
            void main() {
                float alpha = texture(u_texture, v_texCoord).r;
                fragColor = vec4(u_color, alpha * v_opacity);
            }
        `,e=this._createShader(s.VERTEX_SHADER,t),n=this._createShader(s.FRAGMENT_SHADER,i);if(this._program=s.createProgram(),s.attachShader(this._program,e),s.attachShader(this._program,n),s.linkProgram(this._program),!s.getProgramParameter(this._program,s.LINK_STATUS))throw new Error("Failed to link WebGL program: "+s.getProgramInfoLog(this._program));s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)}_createShader(s,t){const i=this._gl,e=i.createShader(s);if(i.shaderSource(e,t),i.compileShader(e),!i.getShaderParameter(e,i.COMPILE_STATUS)){const n=i.getShaderInfoLog(e);throw i.deleteShader(e),new Error(`Failed to compile shader: ${n}`)}return e}}const S=p=>{switch(p){case"WebGL":if(typeof WebGL2RenderingContext<"u")try{return new v}catch{return new m}else return new m;case"2D":return new m;default:throw new Error("Unknown renderer type given!")}},D={color:"#3e3e80ff",fontSize:32,fontFamily:"monospace",backgroundColor:"#181818ff",padding:0,rendererType:"2D",enableMouseInteraction:!1,animated:!1,animationSpeed:1,charSpacingX:void 0,charSpacingY:void 0,resizeTo:window},C=()=>({canvas:null,renderer:null,pattern:null,region:null,options:D,lastTime:0,animationId:null,animationTime:0,mouseX:0,mouseY:0,mouseClicked:!1,tempCanvas:null,tempContext:null,lastHash:0,isDirty:!0,resizeObserver:null});class y{constructor(s,t,i={}){h(this,"_state",C());h(this,"_handleResize");h(this,"_mouseMoveHandler",s=>{const t=this.canvas.getBoundingClientRect();this._state.mouseX=s.clientX-t.left,this._state.mouseY=s.clientY-t.top});h(this,"_mouseClickHandler",()=>{this._state.mouseClicked=!0});this._state.canvas=s,this._state.pattern=t||new f,this._handleResize=this.resize.bind(this),this._state.options={...D,...i},this._state.renderer=S(this._state.options.rendererType||"2D"),this._state.region=this._calculateRegion(),this._setupRenderer(),this._state.options.enableMouseInteraction&&this._setupMouseEvents()}get options(){return this._state.options}get pattern(){if(!this._state.pattern)throw new Error("Pattern not initialized");return this._state.pattern}set pattern(s){this._state.pattern&&this._state.pattern.destroy(),this._state.pattern=s,this._state.region&&this._state.pattern.initialize(this._state.region),this._resetAnimationTime()}get isAnimating(){return this._state.options.animated}get canvas(){if(!this._state.canvas)throw new Error("Canvas not initialized.");return this._state.canvas}get renderer(){if(!this._state.renderer)throw new Error("Renderer not initialized.");return this._state.renderer}get region(){if(!this._state.region)throw new Error("Region not calculated.");return this._state.region}get tempContext(){if(!this._state.tempCanvas&&(this._state.tempCanvas=document.createElement("canvas"),this._state.tempContext=this._state.tempCanvas.getContext("2d"),!this._state.tempContext))throw new Error("Failed to create 2D context for temp canvas");if(!this._state.tempContext)throw new Error("Temp context not initialized.");return this._state.tempContext}render(s=performance.now()){const t=s-this._state.lastTime;this._state.lastTime=s,this._state.options.animated&&(this._state.animationTime+=t/1e3*this._state.options.animationSpeed);const i={time:this._state.animationTime,deltaTime:t/1e3,animationTime:this._state.animationTime,region:this.region,mouseX:this._state.mouseX,mouseY:this._state.mouseY,clicked:this._state.mouseClicked,isAnimating:this._state.options.animated,animationSpeed:this._state.options.animationSpeed};this._state.mouseClicked=!1;const e=this.pattern.update(i).generate(i);!this._hasOutputChanged(e)&&!this._state.isDirty&&!this.pattern.isDirty||(this.pattern.isDirty=!1,this._state.isDirty=!1,this._state.lastHash=this._hash(e),this.renderer.clear(this._state.options.backgroundColor),this.renderer.render(e,this.region))}startAnimation(){if(this._state.animationId)throw new Error("Animation is already running!");this._state.options.animated=!0,this._state.lastTime=performance.now();const s=t=>{this.isAnimating&&(this.render(t),this._state.animationId=requestAnimationFrame(s))};this._state.animationId=requestAnimationFrame(s)}stopAnimation(){this._state.options.animated=!1,this._state.animationId!==null&&(cancelAnimationFrame(this._state.animationId),this._state.animationId=null)}setOptions(s){const t=this._state.options;this._state.options={...t,...s},this._state.isDirty=this._hasOptionsChanged(t),this._state.region=this._calculateRegion(),this.pattern.initialize(this._state.region),this.renderer.options=this._state.options,this._syncAnimationState()}resize(){const s=this._state.options.resizeTo instanceof HTMLElement?this._state.options.resizeTo.clientWidth:this._state.options.resizeTo.innerWidth,t=this._state.options.resizeTo instanceof HTMLElement?this._state.options.resizeTo.clientHeight:this._state.options.resizeTo.innerHeight;this.canvas.width=s,this.canvas.height=t,this._state.region=this._calculateRegion(),this.renderer.resize(s,t),this.pattern.initialize(this._state.region),this.isAnimating||(this._state.isDirty=!0,this.render())}destroy(){this.stopAnimation(),this._state.pattern?.destroy(),this._state.renderer?.destroy(),this._state.canvas?.removeEventListener("mousemove",this._mouseMoveHandler),this._state.canvas?.removeEventListener("click",this._mouseClickHandler),this._state.options.resizeTo.removeEventListener("resize",this._handleResize),this._state.resizeObserver?.disconnect(),this._state=C()}_calculateSpacing(){let s=0;for(const r of this.pattern.options.characters){const _=this.tempContext.measureText(r);s=Math.max(s,_.width)}const t=s,i=this.tempContext.measureText(this.pattern.options.characters.join("")),e=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent,n=Math.max(e,this._state.options.fontSize),a=this._state.options.charSpacingX&&this._state.options.charSpacingX>0?this._state.options.charSpacingX:t,o=this._state.options.charSpacingY&&this._state.options.charSpacingY>0?this._state.options.charSpacingY:Math.max(n,this._state.options.fontSize*1.2);return[t,n,a,o]}_calculateRegion(){this.tempContext.font=`${this._state.options.fontSize}px ${this._state.options.fontFamily}`;const[s,t,i,e]=this._calculateSpacing(),n=Math.floor(this.canvas.width/i),a=Math.floor(this.canvas.height/e);return{startColumn:this._state.options.padding,endColumn:n-this._state.options.padding,startRow:this._state.options.padding,endRow:a-this._state.options.padding,columns:n,rows:a,charWidth:s,charHeight:t,charSpacingX:i,charSpacingY:e,canvasWidth:this.canvas.width,canvasHeight:this.canvas.height}}_setupRenderer(){this.renderer.initialize(this.canvas,this._state.options),this.pattern.initialize(this.region),this._state.options.resizeTo instanceof HTMLElement?(this._state.resizeObserver=new ResizeObserver(this._handleResize),this._state.resizeObserver.observe(this._state.options.resizeTo)):this._state.options.resizeTo.addEventListener("resize",this._handleResize)}_setupMouseEvents(){this.canvas.addEventListener("mousemove",this._mouseMoveHandler),this.canvas.addEventListener("click",this._mouseClickHandler)}_resetAnimationTime(){this._state.animationTime=0}_syncAnimationState(){this._state.options.animated&&this._state.animationId===null?this.startAnimation():!this._state.options.animated&&this._state.animationId!==null&&this.stopAnimation()}_hash(s){let t=0;for(const{x:i,y:e,char:n,color:a="",opacity:o=1,scale:r=1,rotation:_=0}of s)t^=(i*31+e*17^n.charCodeAt(0))+(a.charCodeAt(0)||0)*13+Math.floor(o*100)*7+Math.floor(r*100)*5+Math.floor(_*100)*3;return t}_hasOutputChanged(s){return this._hash(s)!==this._state.lastHash}_hasOptionsChanged(s){return Object.keys(s).some(t=>{const i=this._state.options[t],e=s[t];return i!==e})}}const g=p=>{let s=p===0?1:p;return()=>(s=s*16807%2147483647,s/2147483647)},L={frequency:.01,octaves:4,persistence:.5,lacunarity:2,seed:0};class M extends d{constructor(t={}){super({...L,...t});h(this,"_permutations");this._permutations=this._generatePermutations(this._options.seed)}get _frequency(){return this._options.frequency}get _octaves(){return this._options.octaves}get _persistence(){return this._options.persistence}get _lacunarity(){return this._options.lacunarity}setOptions(t){const i=this._options.seed;super.setOptions(t),t.seed!==void 0&&t.seed!==i&&(this._permutations=this._generatePermutations(this._options.seed))}update(t){return this}generate({animationTime:t,region:i}){if(this.options.characters.length===0)return[];const e=[];for(let n=i.startRow;n<=i.endRow;n++)for(let a=i.startColumn;a<=i.endColumn;a++){const o=this._fractalNoise(a*this._options.frequency,n*this._options.frequency,t*.001),r=Math.max(0,Math.min(1,(o+1)/2)),_=Math.floor(r*this._options.characters.length),u=Math.max(0,Math.min(_,this._options.characters.length-1));e.push({char:this._options.characters[u],x:a*i.charSpacingX,y:n*i.charSpacingY,opacity:r})}return e}_generatePermutations(t){const i=g(t),e=Array.from({length:256},(n,a)=>a);for(let n=255;n>0;n--){const a=Math.floor(i()*(n+1)),o=e[n];e[n]=e[a],e[a]=o}return e.concat(e)}_fade(t){return t*t*t*(t*(t*6-15)+10)}_lerp(t,i,e){return t+e*(i-t)}_gradient3D(t,i,e,n){const a=t&15,o=a<8?i:e,r=a<4?e:a===12||a===14?i:n;return((a&1)===0?o:-o)+((a&2)===0?r:-r)}_noise3D(t,i,e){const n=Math.floor(t)&255,a=Math.floor(i)&255,o=Math.floor(e)&255;t-=Math.floor(t),i-=Math.floor(i),e-=Math.floor(e);const r=this._fade(t),_=this._fade(i),u=this._fade(e),T=this._permutations[n]+a&255,I=this._permutations[T]+o&255,A=this._permutations[T+1&255]+o&255,z=this._permutations[n+1&255]+a&255,b=this._permutations[z]+o&255,E=this._permutations[z+1&255]+o&255;return this._lerp(this._lerp(this._lerp(this._gradient3D(this._permutations[I],t,i,e),this._gradient3D(this._permutations[b],t-1,i,e),r),this._lerp(this._gradient3D(this._permutations[A],t,i-1,e),this._gradient3D(this._permutations[E],t-1,i-1,e),r),_),this._lerp(this._lerp(this._gradient3D(this._permutations[I+1&255],t,i,e-1),this._gradient3D(this._permutations[b+1&255],t-1,i,e-1),r),this._lerp(this._gradient3D(this._permutations[A+1&255],t,i-1,e-1),this._gradient3D(this._permutations[E+1&255],t-1,i-1,e-1),r),_),u)}_fractalNoise(t,i,e=0){let n=0,a=0,o=1,r=1;for(let _=0;_<this._octaves;_++)n+=this._noise3D(t*r,i*r,e*r)*o,a+=o,o*=this._persistence,r*=this._lacunarity;return n/a}_animatedNoise(t,i,e){const a=this._frequency,o=this._fractalNoise(t*a,i*a,e*.01),r=this._fractalNoise((t+1e3)*a,(i+1e3)*a,e*.01*.8);return(o+r*.5)/1.5}_getNoiseFunction(t="down"){return(i,e,n)=>{let a=i,o=e;const r=n;switch(t){case"left":a=i+n*.5;break;case"right":a=i-n*.5;break;case"up":o=e+n*.5;break;case"down":o=e-n*.5;break}return this._animatedNoise(a,o,r)}}}h(M,"ID","perlin-noise");const O={rainDensity:.8,minDropLength:8,maxDropLength:25,minSpeed:.5,maxSpeed:1.5,mutationRate:.04,fadeOpacity:.2,headColor:"#FFFFFF"};class x extends d{constructor(t={}){super({...O,...t});h(this,"_rainDrops",[]);h(this,"_region",null);h(this,"_lastFrameCharacters",[])}initialize(t){const i=this._rainDrops.length>0,e=this._region;this._region=t,!i||!e||Math.abs(e.columns-t.columns)>2||Math.abs(e.rows-t.rows)>2?(this._rainDrops=[],this._lastFrameCharacters=[],this._initializeRainDrops()):(this._adjustDropsToNewRegion(e,t),this._maintainRainDensity())}update(t){return this._region?(this._updateRainDrops(t),this._maintainRainDensity(),this):this}generate(t){if((!this._region||this._rainDrops.length===0)&&(this._region&&this._rainDrops.length===0&&this._initializeRainDrops(),this._rainDrops.length===0))return[];const i=[];if(this._options.fadeOpacity>0)for(const e of this._lastFrameCharacters)i.push({...e,opacity:this._options.fadeOpacity});for(const e of this._rainDrops)this._renderRainDrop(e,i,t);return this._lastFrameCharacters=i.filter(e=>e.opacity!==this._options.fadeOpacity),i}_initializeRainDrops(){if(!this._region)return;const t=Math.floor(this._region.columns*this._options.rainDensity),i=Math.max(1,t);for(let e=0;e<i;e++){const n=Math.floor(Math.random()*this._region.columns)+this._region.startColumn,a=this._createRainDrop(n,0);e<Math.max(1,Math.floor(i*.3))&&(a.y=Math.random()*this._region.rows),this._rainDrops.push(a)}}_createRainDrop(t,i=0){const e=Math.floor(Math.random()*(this._options.maxDropLength-this._options.minDropLength))+this._options.minDropLength,n=Array.from({length:e},()=>this._options.characters[Math.floor(Math.random()*this._options.characters.length)]);return{y:-Math.floor(Math.random()*e)-Math.random()*10,column:t,length:e,characters:n,lastMutationTime:i,speed:Math.random()*(this._options.maxSpeed-this._options.minSpeed)+this._options.minSpeed}}_updateRainDrops(t){if(this._region)for(const i of this._rainDrops){if(t.isAnimating&&(i.y+=i.speed*t.animationSpeed*t.deltaTime),t.animationTime-i.lastMutationTime>1/this._options.mutationRate&&Math.random()<this._options.mutationRate){const e=Math.floor(Math.random()*i.length);i.characters[e]=this._options.characters[Math.floor(Math.random()*this._options.characters.length)],i.lastMutationTime=t.animationTime}i.y-i.length>this._region.endRow&&this._resetRainDrop(i,t.animationTime)}}_resetRainDrop(t,i){this._region&&(t.lastMutationTime=i,t.y=-Math.floor(Math.random()*8)-t.length,t.length=Math.floor(Math.random()*(this._options.maxDropLength-this._options.minDropLength))+this._options.minDropLength,t.characters=Array.from({length:t.length},()=>this._options.characters[Math.floor(Math.random()*this._options.characters.length)]),t.speed=Math.random()*(this._options.maxSpeed-this._options.minSpeed)+this._options.minSpeed,t.column=Math.floor(Math.random()*this._region.columns)+this._region.startColumn)}_maintainRainDensity(){if(!this._region)return;const t=Math.floor(this._region.columns*this._options.rainDensity);for(;this._rainDrops.length<t;){const i=this._rainDrops.length%this._region.columns+this._region.startColumn,e=this._createRainDrop(i,0);Math.random()<.4&&(e.y=Math.random()*this._region.rows+this._region.startRow),this._rainDrops.push(e)}this._rainDrops.length>t&&(this._rainDrops.length=t)}_adjustDropsToNewRegion(t,i){for(const e of this._rainDrops)e.column>=i.startColumn+i.columns?e.column=e.column%i.columns+i.startColumn:e.column<i.startColumn&&(e.column=i.startColumn)}_renderRainDrop(t,i,e){if(this._region)for(let n=0;n<t.length;n++){const a=Math.floor(t.y)-n;if(a<this._region.startRow||a>this._region.endRow||t.column<this._region.startColumn||t.column>this._region.endColumn)continue;const o=t.column*this._region.charSpacingX,r=a*this._region.charSpacingY;let _,u=1;n===0?_=this._options.headColor:n>=3&&(u=1-n/t.length),i.push({x:o,y:r,color:_,opacity:u,char:t.characters[n]})}}destroy(){this._rainDrops=[],this._lastFrameCharacters=[],this._region=null}setOptions(t){if(super.setOptions(t),t.rainDensity!==void 0&&this._region&&this._maintainRainDensity(),t.characters!==void 0)for(const i of this._rainDrops)i.characters=Array.from({length:i.length},()=>this._options.characters[Math.floor(Math.random()*this._options.characters.length)])}}h(x,"ID","rain");const P={seed:0};class R extends d{constructor(s={}){super({...P,...s})}update(s){return this}generate({region:s,animationTime:t}){const i=[],e=g(this._options.seed+Math.floor(t*10));for(let n=s.startRow;n<=s.endRow;n++)for(let a=s.startColumn;a<=s.endColumn;a++){const o=Math.floor(e()*this._options.characters.length),r=this._options.characters[o]||" ";i.push({char:r,x:a*s.charSpacingX,y:n*s.charSpacingY})}return i}}h(R,"ID","static");class w{constructor(){h(this,"_renderer",null)}get pattern(){return this.renderer.pattern}get options(){return Object.freeze(this.renderer.options)}get renderer(){if(!this._renderer)throw new Error("Renderer is not initialized - call init() first.");return this._renderer}set renderer(s){this._renderer=s}init(s,t,i){return this.renderer=new y(s,t,i),this}startAnimation(){return this.renderer.startAnimation(),this}stopAnimation(){return this.renderer.stopAnimation(),this}setPattern(s){return this.renderer.pattern=s,this}setOptions(s){return this.renderer.setOptions(s),this}destroy(){this.renderer.destroy(),this.renderer=null}}c.ASCIIGround=w,c.ASCIIRenderer=y,c.Canvas2DRenderer=m,c.DummyPattern=f,c.Pattern=d,c.PerlinNoisePattern=M,c.RainPattern=x,c.StaticNoisePattern=R,c.WebGLRenderer=v,c.createRenderer=S,c.createSeededRandom=g,c.default=w,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
